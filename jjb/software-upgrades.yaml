---
# voltha 2.X tests

- project:
    name: software-upgrades
    project-name: '{name}'

    jobs:
      - 'software-upgrades-test':
          name: 'periodic-software-upgrade-test-bbsim'
          pipeline-script: 'voltha/master/software-upgrades.groovy'
          build-node: 'qct-pod4-node2'
          code-branch: 'master'
          aaa-version: '2.3.0.SNAPSHOT'
          aaa-oar-url: 'https://oss.sonatype.org/content/groups/public/org/opencord/aaa-app/2.3.0-SNAPSHOT/aaa-app-2.3.0-20201210.223737-1.oar'
          olt-version: ''
          olt-oar-url: ''
          dhcpl2relay-version: ''
          dhcpl2relay-oar-url: ''
          igmpproxy-version: ''
          igmpproxy-oar-url: ''
          sadis-version: ''
          sadis-oar-url: ''
          mcast-version: ''
          mcast-oar-url: ''
          kafka-version: ''
          kafka-oar-url: ''
          adapter-open-olt-image: 'voltha/voltha-openolt-adapter:3.1.3'
          adapter-open-onu-image: ''
          rw-core-image: ''
          ofagent-image: ''
          time-trigger: "H H/23 * * *"

- job-template:
    id: 'software-upgrades-test'
    name: '{name}'
    sandbox: true
    volthaSystemTestsChange: ''
    volthaHelmChartsChange: ''
    kindVolthaChange: ''

    description: |
      <!-- Managed by Jenkins Job Builder -->
      Created by {id} job-template from ci-management/jjb/software-upgrades.yaml  <br /><br />
      E2E Validation for Voltha 2.X
    properties:
      - cord-infra-properties:
          build-days-to-keep: '{build-days-to-keep}'
          artifact-num-to-keep: '{artifact-num-to-keep}'

    wrappers:
      - lf-infra-wrappers:
          build-timeout: '{build-timeout}'
          jenkins-ssh-credential: '{jenkins-ssh-credential}'

    parameters:
      - string:
          name: buildNode
          default: '{build-node}'
          description: 'Name of the Jenkins node to run the job on'

      - string:
          name: extraHelmFlags
          default: ''
          description: 'Helm flags to pass to ./voltha up'

      - string:
          name: volthaSystemTestsChange
          default: ''
          description: 'Download a change for gerrit in the voltha-system-tests repo, example value: "refs/changes/79/18779/13"'

      - string:
          name: volthaHelmChartsChange
          default: ''
          description: 'Download a change for gerrit in the voltha-helm-charts repo, example value: "refs/changes/79/18779/13"'

      - string:
          name: branch
          default: '{code-branch}'
          description: 'Name of the branch to use'

      # deprecated params (not used in master, remove after 2.6 support is dropped)
      - string:
          name: kindVolthaChange
          default: ''
          description: 'Download a change for gerrit in the kind-voltha repo, example value: "refs/changes/32/19132/1"'

      - string:
          name: onosImg
          default: ''
          description: 'ONOS Image to use'

      - string:
          name: aaaVer
          default: '{aaa-version}'
          description: 'ONOS AAA App Version to Test Upgrade'

      - string:
          name: aaaOarUrl
          default: '{aaa-oar-url}'
          description: 'ONOS AAA App OAR File Url'

      - string:
          name: oltVer
          default: '{olt-version}'
          description: 'ONOS OLT App Version to Test Upgrade'

      - string:
          name: oltOarUrl
          default: '{olt-oar-url}'
          description: 'ONOS OLT App OAR File Url'

      - string:
          name: dhcpl2relayVer
          default: '{dhcpl2relay-version}'
          description: 'ONOS DHCP L2 Relay App Version to Test Upgrade'

      - string:
          name: dhcpl2relayOarUrl
          default: '{dhcpl2relay-oar-url}'
          description: 'ONOS DHCP L2 Relay App OAR File Url'

      - string:
          name: igmpproxyVer
          default: '{igmpproxy-version}'
          description: 'ONOS Igmp Proxy App Version to Test Upgrade'

      - string:
          name: igmpproxyOarUrl
          default: '{igmpproxy-oar-url}'
          description: 'ONOS Igmp Proxy App OAR File Url'

      - string:
          name: sadisVer
          default: '{sadis-version}'
          description: 'ONOS Sadis App Version to Test Upgrade'

      - string:
          name: sadisOarUrl
          default: '{sadis-oar-url}'
          description: 'ONOS Sadis App OAR File Url'

      - string:
          name: mcastVer
          default: '{mcast-version}'
          description: 'ONOS MCast App Version to Test Upgrade'

      - string:
          name: mcastOarUrl
          default: '{mcast-oar-url}'
          description: 'ONOS MCast App OAR File Url'

      - string:
          name: kafkaVer
          default: '{kafka-version}'
          description: 'ONOS Kafka App Version to Test Upgrade'

      - string:
          name: kafkaOarUrl
          default: '{kafka-oar-url}'
          description: 'ONOS Kafka App OAR File Url'

      - string:
          name: adapterOpenOltImage
          default: '{adapter-open-olt-image}'
          description: 'Voltha Adapter Open OLT Component Image'

      - string:
          name: adapterOpenOnuImage
          default: '{adapter-open-onu-image}'
          description: 'Voltha Adapter Open ONU Component Image'

      - string:
          name: rwCoreImage
          default: '{rw-core-image}'
          description: 'Voltha RW Core Component Image'

      - string:
          name: ofAgentImage
          default: '{ofagent-image}'
          description: 'Voltha Ofagent Component Image'

    project-type: pipeline
    concurrent: true

    dsl: !include-raw-escape: pipeline/{pipeline-script}

    triggers:
      - timed: |
                 TZ=America/Los_Angeles
                 {time-trigger}

